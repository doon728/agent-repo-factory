name: Repo Request Listener

on:
  issues:
    types: [opened]

jobs:
  read-issue:
    runs-on: ubuntu-latest

    steps:
      - name: Parse issue form fields
        env:
          ISSUE_BODY: ${{ github.event.issue.body }}
        run: |
          python - <<'PY'
          import os, re

          body = os.environ.get("ISSUE_BODY", "")
          lines = [l.rstrip() for l in body.splitlines()]

          # GitHub issue forms typically render like:
          # ### Repo name
          # value
          # ### Agent topology
          # value
          # ### Repo visibility
          # value
          def get_value(label: str) -> str:
              for i, line in enumerate(lines):
                  if line.strip() == f"### {label}":
                      # Find next non-empty line after the heading
                      for j in range(i+1, len(lines)):
                          v = lines[j].strip()
                          if v:
                              return v
              return ""

          repo_name = get_value("Repo name")
          topology = get_value("Agent topology")
          visibility = get_value("Repo visibility")

          print(f"repo_name={repo_name}")
          print(f"folder_layout_template={topology}")
          print(f"repo_visibility={visibility}")

          # Write to GITHUB_OUTPUT so later steps can reuse them
          out_path = os.environ.get("GITHUB_OUTPUT")
          if out_path:
              with open(out_path, "a") as f:
                  f.write(f"repo_name={repo_name}\n")
                  f.write(f"folder_layout_template={topology}\n")
                  f.write(f"repo_visibility={visibility}\n")
          PY

