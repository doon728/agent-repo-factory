name: Repo Request Listener

on:
  issues:
    types: [opened]

jobs:
  create-repo:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      actions: write

    steps:
      - name: Parse issue form fields
        id: parse
        env:
          ISSUE_BODY: ${{ github.event.issue.body }}
        run: |
          python - <<'PY'
          import os

          body = os.environ.get("ISSUE_BODY", "")
          lines = [l.rstrip() for l in body.splitlines()]

          def get_value(label: str) -> str:
              for i, line in enumerate(lines):
                  if line.strip() == f"### {label}":
                      for j in range(i+1, len(lines)):
                          v = lines[j].strip()
                          if v:
                              return v
              return ""

          repo_name = get_value("Repo name")
          topology = get_value("Agent topology")
          visibility = get_value("Repo visibility")

          print(f"repo_name={repo_name}")
          print(f"topology={topology}")
          print(f"visibility={visibility}")

          out_path = os.environ.get("GITHUB_OUTPUT")
          with open(out_path, "a") as f:
              f.write(f"repo_name={repo_name}\n")
              f.write(f"topology={topology}\n")
              f.write(f"visibility={visibility}\n")
          PY

      - name: Map topology to template
        id: map
        run: |
          case "${{ steps.parse.outputs.topology }}" in
            SINGLE_AGENT_BASIC)
              echo "template=tmpl-python-langgraph-single" >> $GITHUB_OUTPUT
              ;;
            MULTI_AGENT_SUPERVISOR)
              echo "template=tmpl-python-langgraph-multi-supervisor" >> $GITHUB_OUTPUT
              ;;
            ROUTER_SPECIALIST)
              echo "template=tmpl-python-langgraph-router-specialist" >> $GITHUB_OUTPUT
              ;;
            PIPELINE_WORKFLOW)
              echo "template=tmpl-python-langgraph-pipeline-workflow" >> $GITHUB_OUTPUT
              ;;
          esac
      - name: Create repository from template
        env:
          GH_TOKEN: ${{ secrets.REPO_FACTORY_TOKEN }}
        run: |
          if [ "${{ steps.parse.outputs.visibility }}" = "PUBLIC" ]; then
            VIS_FLAG="--public"
          else
            VIS_FLAG="--private"
          fi

          gh repo create "${{ steps.parse.outputs.repo_name }}" \
            --template "doon728/${{ steps.map.outputs.template }}" \
            $VIS_FLAG \
            --confirm yes

